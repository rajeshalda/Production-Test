<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meeting Time Tracker</title>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        const msalConfig = {
            auth: {
                clientId: "{{ config.AZURE_CLIENT_ID }}",
                authority: "https://login.microsoftonline.com/{{ config.AZURE_TENANT_ID }}",
                redirectUri: window.location.origin + "/auth/auth-start",
                navigateToLoginRequestUrl: true,
                postLogoutRedirectUri: window.location.origin + "/auth/auth-start"
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: true,
                secureCookies: true
            },
            system: {
                loggerOptions: {
                    logLevel: "Info",
                    piiLoggingEnabled: false
                }
            }
        };

        // Initialize MSAL instance
        const msalInstance = new msal.PublicClientApplication(msalConfig);

        // Handle the redirect promise when page loads
        msalInstance.handleRedirectPromise()
            .then(async (response) => {
                console.log("Handling redirect response:", response);
                
                if (response) {
                    try {
                        // Get account information
                        const account = response.account;
                        console.log("Account info:", account);

                        // Send account info to backend
                        const result = await fetch('/auth/callback', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ account: account })
                        });

                        if (!result.ok) {
                            throw new Error('Backend authentication failed');
                        }

                        const data = await result.json();
                        console.log("Backend response:", data);

                        if (data.redirect) {
                            window.location.href = data.redirect;
                        }
                    } catch (error) {
                        console.error("Error processing authentication:", error);
                        // Redirect to auth-start on error
                        window.location.href = '/auth/auth-start';
                    }
                }
            })
            .catch(error => {
                console.error("Error handling redirect:", error);
                // Clear any cached data and redirect to auth-start
                msalInstance.clearCache();
                window.location.href = '/auth/auth-start';
            });

        // Handle sign out
        async function signOut() {
            try {
                // Call backend logout endpoint
                const response = await fetch('/auth/logout');
                const data = await response.json();
                
                if (data.success) {
                    // Clear MSAL cache
                    msalInstance.clearCache();
                    
                    // Get all accounts and remove them
                    const accounts = msalInstance.getAllAccounts();
                    accounts.forEach(account => {
                        msalInstance.logoutRedirect({
                            account: account,
                            postLogoutRedirectUri: window.location.origin + "/auth/auth-start"
                        });
                    });
                    
                    // If no accounts found, just redirect
                    if (accounts.length === 0) {
                        window.location.href = data.redirect;
                    }
                } else {
                    throw new Error(data.error || 'Logout failed');
                }
            } catch (error) {
                console.error("Error during sign out:", error);
                window.location.href = '/auth/auth-start';
            }
        }
    </script>
</head>
<body class="bg-gray-100">
    {% block content %}{% endblock %}
</body>
</html> 